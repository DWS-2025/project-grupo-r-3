<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UniTalk</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="icon" href="/images/mini.png" type="image/x-icon">
</head>
<body>
<header>
    <div class="header-container">
        <a href="/" class="logo">
            <img src="/images/unitalklogo1.png" alt="UniTalk Logo">
        </a>
        <nav>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/subjects">Subjects</a></li>
                <li><a href="/subjects/my">Forum</a></li>
                <li>
                    <a href="#" class="logout-link" onclick="logout()">Logout</a>
                </li>

                {{#currentUser}}
                <li class="user-nav">
                    <a href="/user" class="user-info">
                        <span class="user-name">@{{username}}</span>
                        {{#profileImage}}
                        <img src="{{profileImage}}" alt="Profile" class="user-avatar">
                        {{/profileImage}}
                        {{^profileImage}}
                        <img src="/images/default-avatar.png" alt="Profile" class="user-avatar">
                        {{/profileImage}}
                    </a>
                </li>
                
                {{/currentUser}}

                {{^currentUser}}
                <li>
                    <a href="/login" class="login-link">Login</a>
                </li>
                {{/currentUser}}

                <li class="search-nav">
                    <button type="button" class="user-search-toggle" onclick="toggleUserSearch()" aria-label="Buscar usuario">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="6" stroke="#0044cc" stroke-width="2"/>
                            <line x1="15.5" y1="15.5" x2="20" y2="20" stroke="#0044cc" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <div class="user-search-wrapper" id="user-search-wrapper">
                        <form class="user-search-form" onsubmit="return goToUserProfile(event)">
                            <input type="text" name="username" class="user-search-input" placeholder="Buscar usuario" autocomplete="off"
                                   oninput="onUserSearchInput(event)" onkeydown="onUserSearchKeyDown(event)">
                        </form>
                        <div class="user-search-results" id="user-search-results"></div>
                    </div>
                </li>
            </ul>
        </nav>
    </div>
    <script>
        function logout() {
            const token = "{{token}}";
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/logout';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = '_csrf';
            input.value = token;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function goToUserProfile(event) {
            event.preventDefault();
            const form = event.target;
            const value = form.username.value.trim();
            if (!value) {
                return false;
            }
            window.location.href = '/user/' + encodeURIComponent(value);
            return false;
        }

        let userSearchTimeout;
        let userSearchItems = [];
        let userSearchActiveIndex = -1;

        function toggleUserSearch() {
            const wrapper = document.getElementById('user-search-wrapper');
            if (!wrapper) return;
            const isOpen = wrapper.classList.contains('open');
            if (isOpen) {
                wrapper.classList.remove('open');
                renderUserSearchResults([]);
            } else {
                wrapper.classList.add('open');
                const input = wrapper.querySelector('.user-search-input');
                if (input) {
                    input.focus();
                }
            }
        }

        function onUserSearchInput(event) {
            const value = event.target.value.trim();
            clearTimeout(userSearchTimeout);

            if (!value) {
                renderUserSearchResults([]);
                return;
            }

            userSearchTimeout = setTimeout(() => {
                fetch('/user/search?query=' + encodeURIComponent(value))
                    .then(response => response.json())
                    .then(data => renderUserSearchResults(data))
                    .catch(() => renderUserSearchResults([]));
            }, 200);
        }

        function renderUserSearchResults(usernames) {
            const container = document.getElementById('user-search-results');
            if (!container) return;

            container.innerHTML = '';
            userSearchItems = [];
            userSearchActiveIndex = -1;

            if (!usernames || usernames.length === 0) {
                container.style.display = 'none';
                return;
            }

            usernames.forEach((user, index) => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'user-search-result-item';
                item.setAttribute('data-index', index.toString());

                const avatar = document.createElement('img');
                avatar.className = 'user-search-avatar';
                const imgSrc = user.profileImage && user.profileImage.trim() !== ''
                    ? user.profileImage
                    : '/images/default-avatar.png';
                avatar.src = imgSrc;
                avatar.alt = 'Avatar ' + user.username;

                const label = document.createElement('span');
                label.className = 'user-search-label';
                label.textContent = '@' + user.username;

                item.appendChild(avatar);
                item.appendChild(label);

                item.onclick = () => {
                    window.location.href = '/user/' + encodeURIComponent(user.username);
                };

                container.appendChild(item);
                userSearchItems.push(item);
            });

            container.style.display = 'block';
        }

        function onUserSearchKeyDown(event) {
            const container = document.getElementById('user-search-results');
            if (!container || container.style.display === 'none') {
                return;
            }

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (userSearchItems.length === 0) return;
                userSearchActiveIndex = (userSearchActiveIndex + 1) % userSearchItems.length;
                updateUserSearchActiveItem();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (userSearchItems.length === 0) return;
                userSearchActiveIndex = (userSearchActiveIndex - 1 + userSearchItems.length) % userSearchItems.length;
                updateUserSearchActiveItem();
            } else if (event.key === 'Enter') {
                if (userSearchActiveIndex >= 0 && userSearchActiveIndex < userSearchItems.length) {
                    event.preventDefault();
                    userSearchItems[userSearchActiveIndex].click();
                }
            }
        }

        function updateUserSearchActiveItem() {
            userSearchItems.forEach((item, index) => {
                if (index === userSearchActiveIndex) {
                    item.classList.add('active');
                    item.focus();
                } else {
                    item.classList.remove('active');
                }
            });
        }
    </script>

</header>
