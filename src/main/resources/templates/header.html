<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UniTalk</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="icon" href="/images/mini.png" type="image/x-icon">
</head>
<body>
<header>
    <div class="header-container">
        <a href="/" class="logo">
            <img src="/images/unitalklogo1.png" alt="UniTalk Logo">
        </a>
        <nav>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/subjects">Subjects</a></li>
                <li><a href="/subjects/my">Forum</a></li>
                <li class="search-nav">
                    <div class="user-search-wrapper">
                        <form class="user-search-form" onsubmit="return goToUserProfile(event)">
                            <input type="text" name="username" class="user-search-input" placeholder="Buscar usuario" autocomplete="off" oninput="onUserSearchInput(event)">
                            <button type="submit" class="user-search-button">Go</button>
                        </form>
                        <div class="user-search-results" id="user-search-results"></div>
                    </div>
                </li>
                <li>
                    <a href="#" class="logout-link" onclick="logout()">Logout</a>
                </li>

                {{#currentUser}}
                <li class="user-nav">
                    <a href="/user" class="user-info">
                        <span class="user-name">@{{username}}</span>
                        {{#profileImage}}
                        <img src="{{profileImage}}" alt="Profile" class="user-avatar">
                        {{/profileImage}}
                        {{^profileImage}}
                        <img src="/images/default-avatar.png" alt="Profile" class="user-avatar">
                        {{/profileImage}}
                    </a>
                </li>
                
                {{/currentUser}}

                {{^currentUser}}
                <li>
                    <a href="/login" class="login-link">Login</a>
                </li>
                {{/currentUser}}
            </ul>
        </nav>
    </div>
    <script>
        function logout() {
            const token = "{{token}}";
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/logout';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = '_csrf';
            input.value = token;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function goToUserProfile(event) {
            event.preventDefault();
            const form = event.target;
            const value = form.username.value.trim();
            if (!value) {
                return false;
            }
            window.location.href = '/user/' + encodeURIComponent(value);
            return false;
        }

        let userSearchTimeout;

        function onUserSearchInput(event) {
            const value = event.target.value.trim();
            clearTimeout(userSearchTimeout);

            if (!value) {
                renderUserSearchResults([]);
                return;
            }

            userSearchTimeout = setTimeout(() => {
                fetch('/user/search?query=' + encodeURIComponent(value))
                    .then(response => response.json())
                    .then(data => renderUserSearchResults(data))
                    .catch(() => renderUserSearchResults([]));
            }, 200);
        }

        function renderUserSearchResults(usernames) {
            const container = document.getElementById('user-search-results');
            if (!container) return;

            container.innerHTML = '';

            if (!usernames || usernames.length === 0) {
                container.style.display = 'none';
                return;
            }

            usernames.forEach(username => {
                const item = document.createElement('div');
                item.className = 'user-search-result-item';
                item.textContent = '@' + username;
                item.onclick = () => {
                    window.location.href = '/user/' + encodeURIComponent(username);
                };
                container.appendChild(item);
            });

            container.style.display = 'block';
        }
    </script>

</header>
